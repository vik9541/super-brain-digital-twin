name: Build and Push Docker Images

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'Dockerfile.api'
      - 'Dockerfile.bot'
      - 'api/**'
      - 'requirements.api.txt'

env:
  REGISTRY: registry.digitalocean.com
  REGISTRY_REPO: digital-twin-registry

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_API_TOKEN_PROD }}
      
      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login
      
      - name: Build and push API image
        run: |
          docker build -f Dockerfile.api -t ${{ env.REGISTRY }}/${{ env.REGISTRY_REPO }}/api:latest .
          docker push ${{ env.REGISTRY }}/${{ env.REGISTRY_REPO }}/api:latest
          echo "API_IMAGE_SIZE=$(docker images ${{ env.REGISTRY }}/${{ env.REGISTRY_REPO }}/api:latest --format '{{.Size}}')" >> $GITHUB_ENV
      
      - name: Build and push Bot image
        run: |
          docker build -f Dockerfile.bot -t ${{ env.REGISTRY }}/${{ env.REGISTRY_REPO }}/bot:latest .
          docker push ${{ env.REGISTRY }}/${{ env.REGISTRY_REPO }}/bot:latest
          echo "BOT_IMAGE_SIZE=$(docker images ${{ env.REGISTRY }}/${{ env.REGISTRY_REPO }}/bot:latest --format '{{.Size}}')" >> $GITHUB_ENV
      
      - name: Verify images in registry
        run: |
          echo "=== Images in DigitalOcean Registry ===\"
          doctl registry repository list-tags ${{ env.REGISTRY_REPO }}/api
          doctl registry repository list-tags ${{ env.REGISTRY_REPO }}/bot
      
      - name: Summary
        run: |
          echo "### Docker Images Built and Pushed âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Images:" >> $GITHUB_STEP_SUMMARY
          echo "- API: \`${{ env.REGISTRY }}/${{ env.REGISTRY_REPO }}/api:latest\` (Size: ${{ env.API_IMAGE_SIZE }})" >> $GITHUB_STEP_SUMMARY
          echo "- Bot: \`${{ env.REGISTRY }}/${{ env.REGISTRY_REPO }}/bot:latest\` (Size: ${{ env.BOT_IMAGE_SIZE }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Update \`k8s/deployments/api-deployment.yaml\` with new image" >> $GITHUB_STEP_SUMMARY
          echo "2. Update \`k8s/deployments/bot-deployment.yaml\` with new image" >> $GITHUB_STEP_SUMMARY
          echo "3. Deploy to Kubernetes cluster" >> $GITHUB_STEP_SUMMARY
