name: Secure Deploy to Kubernetes

on:
  push:
    branches:
      - main
    paths:
      - 'k8s/**'
      - '.github/workflows/deploy-with-secrets.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.34.1'
          
      - name: Configure kubeconfig
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG_PROD }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_CONTENT" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          kubectl cluster-info
          
      - name: Create/Update DigitalOcean Secret
        env:
          DO_API_TOKEN: ${{ secrets.DO_API_TOKEN_PROD }}
        run: |
          kubectl delete secret do-api-token -n super-brain-prod --ignore-not-found
          kubectl create secret generic do-api-token \
            --from-literal=token="$DO_API_TOKEN" \
            -n super-brain-prod
          kubectl label secret do-api-token -n super-brain-prod app=super-brain --overwrite
          
      - name: Create/Update Supabase Secret
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          kubectl delete secret supabase-credentials -n super-brain-prod --ignore-not-found
          kubectl create secret generic supabase-credentials \
            --from-literal=url="$SUPABASE_URL" \
            --from-literal=anon-key="$SUPABASE_ANON_KEY" \
            --from-literal=service-role-key="$SUPABASE_SERVICE_ROLE_KEY" \
            -n super-brain-prod
          kubectl label secret supabase-credentials -n super-brain-prod app=super-brain --overwrite
          
      - name: Create/Update Telegram Secret
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          kubectl delete secret telegram-credentials -n super-brain-prod --ignore-not-found
          kubectl create secret generic telegram-credentials \
            --from-literal=bot-token="$TELEGRAM_BOT_TOKEN" \
            -n super-brain-prod
          kubectl label secret telegram-credentials -n super-brain-prod app=super-brain --overwrite
          
      - name: Create/Update Docker Registry Secret
        env:
          DO_REGISTRY_USERNAME: ${{ secrets.DO_REGISTRY_USERNAME }}
          DO_REGISTRY_TOKEN: ${{ secrets.DO_REGISTRY_TOKEN }}
        run: |
          kubectl delete secret do-registry -n super-brain-prod --ignore-not-found
          kubectl create secret docker-registry do-registry \
            --docker-server=registry.digitalocean.com \
            --docker-username="$DO_REGISTRY_USERNAME" \
            --docker-password="$DO_REGISTRY_TOKEN" \
            -n super-brain-prod
          kubectl label secret do-registry -n super-brain-prod app=super-brain --overwrite
          
      - name: Create/Update ConfigMaps
        env:
          API_HOST: 0.0.0.0
          API_PORT: "8000"
          API_WORKERS: "4"
          ENVIRONMENT: production
          LOG_LEVEL: INFO
        run: |
          kubectl delete configmap api-config -n super-brain-prod --ignore-not-found
          kubectl create configmap api-config \
            --from-literal=API_HOST="$API_HOST" \
            --from-literal=API_PORT="$API_PORT" \
            --from-literal=API_WORKERS="$API_WORKERS" \
            --from-literal=ENVIRONMENT="$ENVIRONMENT" \
            --from-literal=LOG_LEVEL="$LOG_LEVEL" \
            -n super-brain-prod
          kubectl label configmap api-config -n super-brain-prod app=super-brain --overwrite
          
      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s/ 
          
      - name: Verify deployment
        run: |
          kubectl rollout status deployment/api -n super-brain-prod --timeout=5m || true
          kubectl get all -n super-brain-prod
          
      - name: Audit secrets
        run: |
          echo "=== Secrets in production namespace ==="
          kubectl get secrets -n super-brain-prod
          echo ""
          echo "=== ConfigMaps in production namespace ==="
          kubectl get configmaps -n super-brain-prod
          
      - name: Notify success
        if: success()
        run: |
          echo "✅ Deployment completed successfully"
          echo "Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          echo "Commit: ${{ github.sha }}"
          
      - name: Notify failure
        if: failure()
        run: |
          echo "❌ Deployment failed"
          echo "Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          echo "Commit: ${{ github.sha }}"
          exit 1
