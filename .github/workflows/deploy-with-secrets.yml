name: Deploy to Kubernetes

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    outputs:
      ready: ${{ steps.check.outputs.ready }}
    steps:
      - name: Check if secrets are configured
        id: check
        run: |
          if [ -z "${{ secrets.KUBECONFIG_PROD }}" ]; then
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "❌ KUBECONFIG_PROD secret is not configured"
          else
            echo "ready=true" >> $GITHUB_OUTPUT
            echo "✅ All required secrets are present"
          fi

  deploy:
    needs: check-secrets
    if: needs.check-secrets.outputs.ready == 'true'
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.34.1'
          
      - name: Configure kubeconfig
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG_PROD }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_CONTENT" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          echo "✅ Kubeconfig configured"
          
      - name: Verify cluster connection
        run: |
          echo "=== Cluster Info ==="
          kubectl cluster-info
          echo ""
          echo "=== Current Context ==="
          kubectl config current-context
          
      - name: Create/Update namespace
        run: |
          kubectl create namespace super-brain-prod --dry-run=client -o yaml | kubectl apply -f -
          echo "✅ Namespace ready"
          
      - name: Create secrets from GitHub Secrets
        run: |
          echo "Creating Kubernetes secrets..."
          
          # DO API Token
          kubectl delete secret do-api-token -n super-brain-prod --ignore-not-found
          kubectl create secret generic do-api-token \
            --from-literal=token="${{ secrets.DO_API_TOKEN_PROD }}" \
            -n super-brain-prod
          echo "✅ Created: do-api-token"
          
          # Supabase
          kubectl delete secret supabase-credentials -n super-brain-prod --ignore-not-found
          kubectl create secret generic supabase-credentials \
            --from-literal=url="${{ secrets.SUPABASE_URL }}" \
            --from-literal=anon-key="${{ secrets.SUPABASE_ANON_KEY }}" \
            --from-literal=service-role-key="${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -n super-brain-prod
          echo "✅ Created: supabase-credentials"
          
          # Telegram
          kubectl delete secret telegram-credentials -n super-brain-prod --ignore-not-found
          kubectl create secret generic telegram-credentials \
            --from-literal=bot-token="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
            -n super-brain-prod
          echo "✅ Created: telegram-credentials"
          
          # Docker Registry
          kubectl delete secret do-registry -n super-brain-prod --ignore-not-found
          kubectl create secret docker-registry do-registry \
            --docker-server=registry.digitalocean.com \
            --docker-username="${{ secrets.DO_REGISTRY_USERNAME }}" \
            --docker-password="${{ secrets.DO_REGISTRY_TOKEN }}" \
            -n super-brain-prod
          echo "✅ Created: do-registry"
          
      - name: Apply Kubernetes manifests
        run: |
          echo "=== Applying K8s manifests ==="
          if [ -d "k8s" ]; then
            kubectl apply -f k8s/ -n super-brain-prod
            echo "✅ Manifests applied"
          else
            echo "⚠️  No k8s/ directory found"
          fi
          
      - name: Wait for deployment
        run: |
          echo "=== Waiting for deployment ==="
          kubectl rollout status deployment/api -n super-brain-prod --timeout=5m 2>/dev/null || echo "⚠️  No 'api' deployment found"
          
      - name: Verify deployment
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployments -n super-brain-prod
          echo ""
          kubectl get pods -n super-brain-prod
          echo ""
          kubectl get services -n super-brain-prod
          
      - name: Success
        if: success()
        run: |
          echo "✅ Deployment completed successfully!"
          echo "Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          echo "Commit: ${{ github.sha }}"
          
      - name: Failure
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          exit 1
  
  setup-required:
    needs: check-secrets
    if: needs.check-secrets.outputs.ready == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Setup Instructions
        run: |
          echo "❌ Setup Required"
          echo ""
          echo "To enable deployment, add these 8 secrets to GitHub:"
          echo ""
          echo "1. Settings → Secrets and variables → Actions"
          echo ""
          echo "2. Click 'New repository secret' and add:"
          echo "   - KUBECONFIG_PROD"
          echo "   - DO_API_TOKEN_PROD"
          echo "   - SUPABASE_URL"
          echo "   - SUPABASE_ANON_KEY"
          echo "   - SUPABASE_SERVICE_ROLE_KEY"
          echo "   - TELEGRAM_BOT_TOKEN"
          echo "   - DO_REGISTRY_USERNAME"
          echo "   - DO_REGISTRY_TOKEN"
          echo ""
          echo "3. See GITHUB_ACTIONS_SETUP.md for detailed instructions"
          echo ""
          exit 1
