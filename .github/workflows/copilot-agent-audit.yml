name: ü§ñ Copilot Agent - Code Audit

# –ó–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞—É–¥–∏—Ç–∞ –∫–æ–¥–∞
on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths:
      - '**.py'
      - '**.yaml'
      - '**.yml'
      - 'Dockerfile*'
      - 'k8s/**'
      - 'requirements*.txt'
      - '.github/copilot-agent.yml'
      
  pull_request:
    types: [opened, synchronize, reopened]
    
  schedule:
    # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00 UTC (5:00 MSK)
    - cron: '0 2 * * *'
    
  workflow_dispatch:
    inputs:
      scan_mode:
        description: '–†–µ–∂–∏–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - security-only
          - python-only
          - kubernetes-only
      auto_fix_enabled:
        description: '–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: write
  checks: write

env:
  PYTHON_VERSION: '3.11'
  COPILOT_AGENT_VERSION: '1.0.0'

jobs:
  # Job 1: –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
  pre-check:
    name: üîç –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      changed_files: ${{ steps.files.outputs.all }}
      
    steps:
      - name: ‚úÖ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: üìÑ –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        id: files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            **/*.py
            **/*.yaml
            **/*.yml
            Dockerfile*
            requirements*.txt
            
      - name: üßê –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–ø—É—Å–∫–∞
        id: check
        run: |
          if [[ "${{ steps.files.outputs.any_changed }}" == "true" ]] || [[ "${{ github.event_name }}" == "schedule" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "‚úÖ –ê—É–¥–∏—Ç –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "‚ùå –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∞—É–¥–∏—Ç"
          fi

  # Job 2: Python –∫–æ–¥ –∞–Ω–∞–ª–∏–∑
  python-audit:
    name: üêç Python Code Audit
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should_run == 'true'
    
    steps:
      - name: ‚úÖ Checkout code
        uses: actions/checkout@v4
        
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint mypy black flake8 bandit safety pytest-cov
          if [ -f requirements.api.txt ]; then pip install -r requirements.api.txt; fi
          
      - name: üîç Type checking (mypy)
        continue-on-error: true
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ type hints..."
          mypy --install-types --non-interactive --ignore-missing-imports . || true
          
      - name: üìä Code quality (pylint)
        continue-on-error: true
        run: |
          echo "üìä –ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞..."
          pylint **/*.py --output-format=json --exit-zero > pylint-report.json || true
          
      - name: üîí Security scan (bandit)
        continue-on-error: true
        run: |
          echo "üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏..."
          bandit -r . -f json -o bandit-report.json || true
          
      - name: üì¶ Dependency vulnerabilities (safety)
        continue-on-error: true
        run: |
          echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          safety check --json > safety-report.json || true
          
      - name: üìù Upload Python audit results
        uses: actions/upload-artifact@v4
        with:
          name: python-audit-results
          path: |
            pylint-report.json
            bandit-report.json
            safety-report.json
          retention-days: 30

  # Job 3: Kubernetes –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏–∑
  kubernetes-audit:
    name: ‚ò∏Ô∏è Kubernetes Audit
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should_run == 'true'
    
    steps:
      - name: ‚úÖ Checkout code
        uses: actions/checkout@v4
        
      - name: üîß Install kubeconform
        run: |
          wget https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/
          
      - name: ‚úÖ Validate Kubernetes manifests
        continue-on-error: true
        run: |
          echo "‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è Kubernetes –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤..."
          kubeconform -summary -output json k8s/*.yaml > k8s-validation.json || true
          
      - name: üîí Security scan with Checkov
        continue-on-error: true
        run: |
          pip install checkov
          echo "üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ K8s..."
          checkov -d k8s/ --framework kubernetes -o json > checkov-k8s-report.json || true
          
      - name: üìù Upload K8s audit results
        uses: actions/upload-artifact@v4
        with:
          name: kubernetes-audit-results
          path: |
            k8s-validation.json
            checkov-k8s-report.json
          retention-days: 30

  # Job 4: Docker —Ñ–∞–π–ª—ã –∞–Ω–∞–ª–∏–∑
  docker-audit:
    name: üê≥ Docker Audit
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should_run == 'true'
    
    steps:
      - name: ‚úÖ Checkout code
        uses: actions/checkout@v4
        
      - name: üîç Dockerfile linting (hadolint)
        continue-on-error: true
        run: |
          docker run --rm -i hadolint/hadolint < Dockerfile.api > hadolint-api.txt || true
          docker run --rm -i hadolint/hadolint < Dockerfile.bot > hadolint-bot.txt || true
          docker run --rm -i hadolint/hadolint < Dockerfile.batch-analyzer > hadolint-batch.txt || true
          docker run --rm -i hadolint/hadolint < Dockerfile.reports-generator > hadolint-reports.txt || true
          
      - name: üîí Trivy vulnerability scan
        continue-on-error: true
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            -v $(pwd):/src aquasec/trivy fs --format json --output trivy-report.json /src || true
          
      - name: üìù Upload Docker audit results
        uses: actions/upload-artifact@v4
        with:
          name: docker-audit-results
          path: |
            hadolint-*.txt
            trivy-report.json
          retention-days: 30

  # Job 5: GitHub Copilot Review
  copilot-review:
    name: ü§ñ Copilot AI Review
    runs-on: ubuntu-latest
    needs: [python-audit, kubernetes-audit, docker-audit]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ‚úÖ Checkout code
        uses: actions/checkout@v4
        
      - name: ü§ñ Request Copilot code review
        uses: github/copilot-code-review-action@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: üìù Add review summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = `## ü§ñ Copilot Agent - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞—É–¥–∏—Ç–∞
            
            ### üêç Python Code Audit
            - ‚úÖ Type checking completed
            - ‚úÖ Code quality analysis completed
            - ‚úÖ Security scan completed
            
            ### ‚ò∏Ô∏è Kubernetes Audit
            - ‚úÖ Manifest validation completed
            - ‚úÖ Security scan completed
            
            ### üê≥ Docker Audit
            - ‚úÖ Dockerfile linting completed
            - ‚úÖ Vulnerability scan completed
            
            üìÅ **–ü–æ–ª–Ω—ã–µ –æ—Ç—á–µ—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤ artifacts**
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  330
  : –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  auto-fix:
    name: üîß –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    runs-on: ubuntu-latest
    needs: [python-audit, kubernetes-audit, docker-audit]
    if: |
      (github.event_name == 'push' || github.event_name == 'schedule') &&
      (github.event.inputs.auto_fix_enabled != 'false')
    
    steps:
      - name: ‚úÖ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: üì¶ Install formatters
        run: |
          pip install black isort autopep8 autoflake
          
      - name: üîß Apply auto-fixes
        run: |
          echo "üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π..."
          
          # –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤
          find . -name '*.py' -not -path '*/venv/*' -not -path '*/__pycache__/*' \
            -exec autoflake --in-place --remove-all-unused-imports {} \;
          
          # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤
          isort . --profile black
          
          # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
          black . --line-length 100
          
      - name: üìù Check for changes
        id: verify
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git diff --stat
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚úÖ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          fi
          
      - name: üíæ Commit auto-fixes
        if: steps.verify.outputs.has_changes == 'true'
              run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Bot"
        git add .
        git commit -m "ü§ñ Auto-fix: Code formatting and import optimization"
        git push

  # Job 6.5: AI-Enhanced Code Analysis
    ai-enhanced-analysis:
    name: ü§ñ AI-Enhanced Analysis (GPT-5.1 + Claude Opus 4.5)
    runs-on: ubuntu-latest
    needs: [python-audit, kubernetes-audit, docker-audit]
    if: always()
    
    steps:
      - name: ‚úÖ Checkout code
        uses: actions/checkout@v4
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f scripts/requirements-copilot.txt ]; then
            pip install -r scripts/requirements-copilot.txt
          fi
      
      - name: üì• Download audit artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: audit-results
      
      - name: ü§ñ Run AI-Enhanced Analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ü§ñ –ó–∞–ø—É—Å–∫ AI-—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞..."
          python scripts/copilot_agent_runner.py \
            --mode comprehensive \
            --audit-results audit-results \
            --output ai-analysis-report.json
      
      - name: üìä Generate Enhanced Report
        run: |
          echo "üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞..."
          python scripts/generate_report.py \
            --input ai-analysis-report.json \
            --output AI_ENHANCED_REPORT.md \
            --format markdown
      
      - name: üì§ Upload AI analysis results
        uses: actions/upload-artifact@v4
        with:
          name: ai-enhanced-analysis
                  path: |
                            ai-analysis-report.json
                                      AI_ENHANCED_REPORT.md
                                              retention-days: 30

Job 7: –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
  final-report:
         name: üìä –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
    runs-on: ubuntu-latest
    needs: [python-audit, kubernetes-audit, docker-audit, copilot-review, auto-fix]
    if: always()
    
    steps:
      - name: ‚úÖ Checkout code
        uses: actions/checkout@v4
        
      - name: üìä Download all artifacts
        uses: actions/download-artifact@v4
        
      - name: üìù Generate summary report
        run: |
          echo "# ü§ñ Copilot Agent - –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –∞—É–¥–∏—Ç–∞" > AUDIT_REPORT.md
          echo "" >> AUDIT_REPORT.md
          echo "**–î–∞—Ç–∞:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> AUDIT_REPORT.md
          echo "**Commit:** ${{ github.sha }}" >> AUDIT_REPORT.md
          echo "**Branch:** ${{ github.ref_name }}" >> AUDIT_REPORT.md
          echo "" >> AUDIT_REPORT.md
          
          echo "## üêç Python Code Audit" >> AUDIT_REPORT.md
          echo "- Type checking: ${{ needs.python-audit.result }}" >> AUDIT_REPORT.md
          echo "- Code quality: ${{ needs.python-audit.result }}" >> AUDIT_REPORT.md
          echo "- Security scan: ${{ needs.python-audit.result }}" >> AUDIT_REPORT.md
          echo "" >> AUDIT_REPORT.md
          
          echo "## ‚ò∏Ô∏è Kubernetes Audit" >> AUDIT_REPORT.md
          echo "- Manifest validation: ${{ needs.kubernetes-audit.result }}" >> AUDIT_REPORT.md
          echo "- Security scan: ${{ needs.kubernetes-audit.result }}" >> AUDIT_REPORT.md
          echo "" >> AUDIT_REPORT.md
          
          echo "## üê≥ Docker Audit" >> AUDIT_REPORT.md
          echo "- Dockerfile linting: ${{ needs.docker-audit.result }}" >> AUDIT_REPORT.md
          echo "- Vulnerability scan: ${{ needs.docker-audit.result }}" >> AUDIT_REPORT.md
          echo "" >> AUDIT_REPORT.md
          
          echo "## üîß Auto-fix Status" >> AUDIT_REPORT.md
          echo "- Auto-fixes applied: ${{ needs.auto-fix.result }}" >> AUDIT_REPORT.md
          
          cat AUDIT_REPORT.md
          
      - name: üì§ Upload final report
        uses: actions/upload-artifact@v4
        with:
          name: final-audit-report
          path: AUDIT_REPORT.md
          retention-days: 90
          
      - name: üìß Create issue for critical findings
        if: contains(needs.*.result, 'failure')
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ö†Ô∏è [CodeAuditor] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã',
              body: `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞—É–¥–∏—Ç –∫–æ–¥–∞ –æ–±–Ω–∞—Ä—É–∂–∏–ª –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã.
              
              **Commit:** ${context.sha}
              **Workflow:** ${context.workflow}
              **Run ID:** ${context.runId}
              
              –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç—á–µ—Ç—ã –≤ artifacts.`,
              labels: ['bug', 'code-quality', 'automated', 'needs-attention']
            });
