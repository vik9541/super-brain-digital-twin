name: 🤖 Copilot Agent - Code Audit

# Запуск агента для автоматического аудита кода
on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths:
      - '**.py'
      - '**.yaml'
      - '**.yml'
      - 'Dockerfile*'
      - 'k8s/**'
      - 'requirements*.txt'
      - '.github/copilot-agent.yml'

  pull_request:
    types: [opened, synchronize, reopened]

  schedule:
    # Каждый день в 2:00 UTC (5:00 MSK)
    - cron: '0 2 * * *'

  workflow_dispatch:
    inputs:
      scan_mode:
        description: 'Режим сканирования'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - security-only
          - python-only
          - kubernetes-only
      auto_fix_enabled:
        description: 'Включить автоматические исправления'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: write
  checks: write

env:
  PYTHON_VERSION: '3.11'
  COPILOT_AGENT_VERSION: '1.0.0'

jobs:
  # Job 1: Предварительная проверка
  pre-check:
    name: 🔍 Предварительная проверка
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      changed_files: ${{ steps.files.outputs.all }}

    steps:
      - name: ✅ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 📄 Получение измененных файлов
        id: files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            **/*.py
            **/*.yaml
            **/*.yml
            Dockerfile*
            requirements*.txt

      - name: 🧐 Проверка необходимости запуска
        id: check
        run: |
          if [[ "${{ steps.files.outputs.any_changed }}" == "true" ]] || [[ "${{ github.event_name }}" == "schedule" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "✅ Аудит будет запущен"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "❌ Изменений нет, пропускаем аудит"
          fi

  # Job 2: Python код анализ
  python-audit:
    name: 🐍 Python Code Audit
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should_run == 'true'

    steps:
      - name: ✅ Checkout code
        uses: actions/checkout@v4

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint mypy black flake8 bandit safety pytest-cov
          if [ -f requirements.api.txt ]; then pip install -r requirements.api.txt; fi

      - name: �� Type checking (mypy)
        continue-on-error: true
        run: |
          echo "🔍 Проверка type hints..."
          mypy --install-types --non-interactive --ignore-missing-imports . || true

      - name: 📊 Code quality (pylint)
        continue-on-error: true
        run: |
          echo "📊 Анализ качества кода..."
          pylint **/*.py --output-format=json --exit-zero > pylint-report.json || true

      - name: 🔒 Security scan (bandit)
        continue-on-error: true
        run: |
          echo "🔒 Проверка безопасности..."
          bandit -r . -f json -o bandit-report.json || true

      - name: 📦 Dependency vulnerabilities (safety)
        continue-on-error: true
        run: |
          echo "📦 Проверка уязвимостей зависимостей..."
          safety check --json > safety-report.json || true

      - name: 📤 Upload Python audit results
        uses: actions/upload-artifact@v4
        with:
          name: python-audit-results
          path: |
            pylint-report.json
            bandit-report.json
            safety-report.json
          retention-days: 30

  # Job 3: Kubernetes конфигурации анализ
  kubernetes-audit:
    name: ☸️ Kubernetes Audit
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should_run == 'true'

    steps:
      - name: ✅ Checkout code
        uses: actions/checkout@v4

      - name: 🔧 Install kubeconform
        run: |
          wget https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: ✅ Validate Kubernetes manifests
        continue-on-error: true
        run: |
          echo "✅ Валидация Kubernetes манифестов..."
          kubeconform -summary -output json k8s/*.yaml > k8s-validation.json || true

      - name: 🔒 Security scan with Checkov
        continue-on-error: true
        run: |
          pip install checkov
          echo "�� Проверка безопасности K8s..."
          checkov -d k8s/ --framework kubernetes -o json > checkov-k8s-report.json || true

      - name: 📤 Upload K8s audit results
        uses: actions/upload-artifact@v4
        with:
          name: kubernetes-audit-results
          path: |
            k8s-validation.json
            checkov-k8s-report.json
          retention-days: 30

  # Job 4: Docker файлы анализ
  docker-audit:
    name: 🐳 Docker Audit
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should_run == 'true'

    steps:
      - name: ✅ Checkout code
        uses: actions/checkout@v4

      - name: 🔍 Dockerfile linting (hadolint)
        continue-on-error: true
        run: |
          docker run --rm -i hadolint/hadolint < Dockerfile.api > hadolint-api.txt || true
          docker run --rm -i hadolint/hadolint < Dockerfile.bot > hadolint-bot.txt || true
          docker run --rm -i hadolint/hadolint < Dockerfile.batch-analyzer > hadolint-batch.txt || true
          docker run --rm -i hadolint/hadolint < Dockerfile.reports-generator > hadolint-reports.txt || true

      - name: 🔒 Trivy vulnerability scan
        continue-on-error: true
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            -v $(pwd):/src aquasec/trivy fs --format json --output trivy-report.json /src || true

      - name: 📤 Upload Docker audit results
        uses: actions/upload-artifact@v4
        with:
          name: docker-audit-results
          path: |
            hadolint-*.txt
            trivy-report.json
          retention-days: 30

  # Job 5: GitHub Copilot Review
  copilot-review:
    name: 🤖 Copilot AI Review
    runs-on: ubuntu-latest
    needs: [python-audit, kubernetes-audit, docker-audit]
    if: github.event_name == 'pull_request'

    steps:
      - name: ✅ Checkout code
        uses: actions/checkout@v4

      - name: 📝 Add review summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = `## 🤖 Copilot Agent - Результаты аудита

            ### 🐍 Python Code Audit
            - ✅ Type checking completed
            - ✅ Code quality analysis completed
            - ✅ Security scan completed

            ### ☸️ Kubernetes Audit
            - ✅ Manifest validation completed
            - ✅ Security scan completed

            ### 🐳 Docker Audit
            - ✅ Dockerfile linting completed
            - ✅ Vulnerability scan completed

            📁 **Полные отчеты доступны в artifacts**
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # Job 6: Автоматические исправления
  auto-fix:
    name: 🔧 Автоматические исправления
    runs-on: ubuntu-latest
    needs: [python-audit, kubernetes-audit, docker-audit]
    if: |
      (github.event_name == 'push' || github.event_name == 'schedule') &&
      (github.event.inputs.auto_fix_enabled != 'false')

    steps:
      - name: ✅ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 📦 Install formatters
        run: |
          pip install black isort autopep8 autoflake

      - name: �� Apply auto-fixes
        run: |
          echo "🔧 Применение автоматических исправлений..."

          # Удаление неиспользуемых импортов
          find . -name '*.py' -not -path '*/venv/*' -not -path '*/__pycache__/*' \
            -exec autoflake --in-place --remove-all-unused-imports {} \;

          # Сортировка импортов
          isort . --profile black

          # Форматирование кода
          black . --line-length 100

      - name: 📝 Check for changes
        id: verify
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git diff --stat
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "✅ Нет изменений для коммита"
          fi

      - name: 💾 Commit auto-fixes
        if: steps.verify.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          git add .
          git commit -m "🤖 Auto-fix: Code formatting and import optimization"
          git pull --rebase origin ${{ github.ref_name }}
          git push

  # Job 6.5: AI-Enhanced Code Analysis
  ai-enhanced-analysis:
    name: 🤖 AI-Enhanced Analysis (GPT-5.1 + Claude Opus 4.5)
    runs-on: ubuntu-latest
    needs: [python-audit, kubernetes-audit, docker-audit]
    if: always()

    steps:
      - name: ✅ Checkout code
        uses: actions/checkout@v4

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f scripts/requirements-copilot.txt ]; then
            pip install -r scripts/requirements-copilot.txt
          fi

      - name: 📥 Download audit artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: audit-results

      - name: 🤖 Run AI-Enhanced Analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "🤖 Запуск AI-расширенного анализа..."
          python scripts/copilot_agent_runner.py \
            --mode comprehensive \
            --audit-results audit-results \
          --files "**/*.py" \
            --output ai-analysis-report.json

      - name: 📊 Generate Enhanced Report
        run: |
          echo "📊 Генерация расширенного отчета..."
          python scripts/generate_report.py \
            --input ai-analysis-report.json \
            --output AI_ENHANCED_REPORT.md \
            --format markdown

      - name: 📤 Upload AI analysis results
        uses: actions/upload-artifact@v4
        with:
          name: ai-enhanced-analysis
          path: |
            ai-analysis-report.json
            AI_ENHANCED_REPORT.md
          retention-days: 30

  # Job 7: Итоговый отчет
  final-report:
    name: 📊 Итоговый отчет
    runs-on: ubuntu-latest
    needs: [python-audit, kubernetes-audit, docker-audit, copilot-review, auto-fix]
    if: always()

    steps:
      - name: ✅ Checkout code
        uses: actions/checkout@v4

      - name: 📊 Download all artifacts
        uses: actions/download-artifact@v4

      - name: �� Generate summary report
        run: |
          echo "# 🤖 Copilot Agent - Полный отчет аудита" > AUDIT_REPORT.md
          echo "" >> AUDIT_REPORT.md
          echo "**Дата:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> AUDIT_REPORT.md
          echo "**Commit:** ${{ github.sha }}" >> AUDIT_REPORT.md
          echo "**Branch:** ${{ github.ref_name }}" >> AUDIT_REPORT.md
          echo "" >> AUDIT_REPORT.md

          echo "## 🐍 Python Code Audit" >> AUDIT_REPORT.md
          echo "- Type checking: ${{ needs.python-audit.result }}" >> AUDIT_REPORT.md
          echo "- Code quality: ${{ needs.python-audit.result }}" >> AUDIT_REPORT.md
          echo "- Security scan: ${{ needs.python-audit.result }}" >> AUDIT_REPORT.md
          echo "" >> AUDIT_REPORT.md

          echo "## ☸️ Kubernetes Audit" >> AUDIT_REPORT.md
          echo "- Manifest validation: ${{ needs.kubernetes-audit.result }}" >> AUDIT_REPORT.md
          echo "- Security scan: ${{ needs.kubernetes-audit.result }}" >> AUDIT_REPORT.md
          echo "" >> AUDIT_REPORT.md

          echo "## 🐳 Docker Audit" >> AUDIT_REPORT.md
          echo "- Dockerfile linting: ${{ needs.docker-audit.result }}" >> AUDIT_REPORT.md
          echo "- Vulnerability scan: ${{ needs.docker-audit.result }}" >> AUDIT_REPORT.md
          echo "" >> AUDIT_REPORT.md

          echo "## 🔧 Auto-fix Status" >> AUDIT_REPORT.md
          echo "- Auto-fixes applied: ${{ needs.auto-fix.result }}" >> AUDIT_REPORT.md

          cat AUDIT_REPORT.md

      - name: 📤 Upload final report
        uses: actions/upload-artifact@v4
        with:
          name: final-audit-report
          path: AUDIT_REPORT.md
          retention-days: 90

      - name: 🔧 Create issue for critical findings
        if: contains(needs.*.result, 'failure')
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠️ [CodeAuditor] Критические проблемы обнаружены',
              body: `Автоматический аудит кода обнаружил критические проблемы.

              **Commit:** ${context.sha}
              **Workflow:** ${context.workflow}
              **Run ID:** ${context.runId}

              Пожалуйста, проверьте отчеты в artifacts.`,
              labels: ['bug', 'code-quality', 'automated', 'needs-attention']
            });
