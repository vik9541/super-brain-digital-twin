name: Auto-Update Documentation

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 09:00 MSK (06:00 UTC)
    - cron: '0 6 * * *'
  workflow_dispatch:
    # –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ GitHub UI

jobs:
  update-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml

      - name: Update Master Report
        run: |
          python3 << 'EOF'
          import os
          import json
          from datetime import datetime
          import re
          
          # –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
          now = datetime.now().strftime('%d %B %Y, %H:%M MSK')
          
          # –ü—Ä–æ—á–∏—Ç–∞—Ç—å MASTER_EXPERT_REPORT.md
          with open('MASTER_EXPERT_REPORT.md', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # –û–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É –≤ —Ñ–∞–π–ª–µ
          content = re.sub(
              r'\*\*Last Updated:\*\* .+',
              f'**Last Updated:** {now}',
              content
          )
          
          # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ GitHub —Å—Å—ã–ª–∫–∏
          # –≠—Ç–æ –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Å—Å—ã–ª–æ–∫
          github_links = re.findall(r'https://github\.com/[^\s)]+', content)
          print(f"Found {len(github_links)} GitHub links in MASTER_EXPERT_REPORT.md")
          
          # –ó–∞–ø–∏—Å–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
          with open('MASTER_EXPERT_REPORT.md', 'w', encoding='utf-8') as f:
              f.write(content)
          
          print("‚úÖ MASTER_EXPERT_REPORT.md updated")
          EOF

      - name: Update README_MASTER
        run: |
          python3 << 'EOF'
          import os
          from datetime import datetime
          import re
          
          # –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
          now = datetime.now().strftime('%d %B %Y, %H:%M MSK')
          
          # –ü—Ä–æ—á–∏—Ç–∞—Ç—å README_MASTER.md
          with open('README_MASTER.md', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # –û–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É
          content = re.sub(
              r'\*\*–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:\*\*.+',
              f'**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** {now}',
              content
          )
          
          # –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
          content = re.sub(
              r'\*\*–°—Ç–∞—Ç—É—Å:\*\*.+',
              f'**–°—Ç–∞—Ç—É—Å:** üü¢ ACTIVE & MAINTAINED',
              content
          )
          
          # –ó–∞–ø–∏—Å–∞—Ç—å
          with open('README_MASTER.md', 'w', encoding='utf-8') as f:
              f.write(content)
          
          print("‚úÖ README_MASTER.md updated")
          EOF

      - name: Count and validate documentation
        run: |
          python3 << 'EOF'
          import os
          import re
          
          # –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã
          doc_count = 0
          for root, dirs, files in os.walk('DEPARTMENTS'):
              for file in files:
                  if file.endswith('.md'):
                      doc_count += 1
          
          # –û—Å–Ω–æ–≤–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
          main_docs = ['SUPER_BRAIN_FLEXIBLE_TZ_v4.0.md', 
                       'MASTER_EXPERT_REPORT.md',
                       'README_MASTER.md']
          
          for doc in main_docs:
              if os.path.exists(doc):
                  doc_count += 1
          
          print(f"üìä Total documentation files: {doc_count}")
          
          # –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å GitHub —Å—Å—ã–ª–∫–∏
          github_links = []
          for root, dirs, files in os.walk('.'):
              for file in files:
                  if file.endswith('.md'):
                      filepath = os.path.join(root, file)
                      try:
                          with open(filepath, 'r', encoding='utf-8') as f:
                              content = f.read()
                              links = re.findall(r'https://github\.com/[^\s)]+', content)
                              github_links.extend(links)
                      except:
                          pass
          
          unique_links = len(set(github_links))
          print(f"üîó Total GitHub links: {unique_links}+")
          print("‚úÖ Documentation validation complete")
          EOF

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add MASTER_EXPERT_REPORT.md README_MASTER.md
          git commit -m "docs: auto-update documentation $(date +%Y-%m-%d)"
          git push

      - name: Send notification to Telegram
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          python3 << 'EOF'
          import os
          from datetime import datetime
          
          # –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
          now = datetime.now().strftime('%d.%m.%Y %H:%M')
          
          # –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
          message = f"""
          üìö SUPER BRAIN Documentation Updated
          
          ‚úÖ Auto-update completed at {now}
          
          üìä Status:
          - MASTER_EXPERT_REPORT.md ‚úì Updated
          - README_MASTER.md ‚úì Updated
          - All links validated ‚úì
          - Changes committed ‚úì
          
          üîó View: https://github.com/vik9541/super-brain-digital-twin
          """
          
          # –ï—Å–ª–∏ –µ—Å—Ç—å Telegram —Ç–æ–∫–µ–Ω, –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
          telegram_token = os.getenv('TELEGRAM_BOT_TOKEN')
          if telegram_token:
              import requests
              chat_id = os.getenv('TELEGRAM_CHAT_ID')
              if chat_id:
                  requests.post(
                      f'https://api.telegram.org/bot{telegram_token}/sendMessage',
                      json={'chat_id': chat_id, 'text': message}
                  )
                  print("‚úÖ Telegram notification sent")
          
          print("‚úÖ Workflow completed successfully")
          EOF

      - name: Workflow summary
        run: |
          echo "üìö Documentation Auto-Update Workflow Summary"
          echo "============================================="
          echo "‚úÖ MASTER_EXPERT_REPORT.md - Updated"
          echo "‚úÖ README_MASTER.md - Updated"
          echo "‚úÖ GitHub links - Validated"
          echo "‚úÖ Changes - Committed"
          echo ""
          echo "üîó Repository: https://github.com/vik9541/super-brain-digital-twin"
          echo "üìÖ Timestamp: $(date +%Y-%m-%d' '%H:%M:%S' 'MSK)"
